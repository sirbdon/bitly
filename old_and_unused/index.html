<!DOCTYPE html>
<html>
<head>
  <title></title>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

  <!-- Latest compiled and minified JavaScript -->
  <script src="http://cdn.embed.ly/jquery.embedly-3.0.5.min.js" type="text/javascript"></script>
  <script src="http://cdn.embed.ly/jquery.preview-0.3.2.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="http://cdn.embed.ly/jquery.preview-0.3.2.css" />

  <script src='jquery.ui.widget.js' type='text/javascript'></script>
  <script src='jquery.iframe-transport.js' type='text/javascript'></script>
  <script src='jquery.fileupload.js' type='text/javascript'></script>
  <script src='jquery.cloudinary.js' type='text/javascript'></script>
  <script src="//widget.cloudinary.com/global/all.js" type="text/javascript"></script>

  <script type="text/javascript">



$(document).ready(function() {



cloudinary.setCloudName('derfniizj');

var cloudinary_cors = "http://" + document.referrer + "/cloudinary_cors.html";




  

  // Don't bind the listeners

  // When a use hits Attach, trigger a preview of the link.
  $('#preview1').click(function(){
    // $('#topUrl').trigger('preview');
    $(this).console.log($('#topUrl').data('preview'));
      return true;
  });

});

</script>


</head>
<body>

<div class="container-fluid">

  <div class="row">
    
    <div class="col-lg-6 col-md-6 col-sm-12">
      <h3>Input Text</h3>
    </div>

    <div class="col-lg-6 col-md-6 hidden-sm">
      <h3>Result</h3>
    </div>

</div>

  <div class="row">

    <div class="col-lg-6 col-md-6 col-sm-12">
      <form id="input" onsubmit="return false">
        <textarea id="input-text" class="form-control" rows="20"></textarea>
        <br>
        <input class="btn btn-primary" type="submit" value="Submit">
        <br><br><br>
        <button id="copyReset" class="btn btn-default">Copy and Reset</button>
        <br><br><br>
        <button id="checkUrls" class="btn btn-default">Check URLs</button>
      </form>
    </div>
    
    <div class="clearfix visible-sm-block visible-xs-block"></div>

    <div class="visible-sm col-sm-12">
      <h3>Result</h3>
    </div>

    <div class="col-lg-6 col-md-6 col-sm-12">
      <form id="output" onsubmit="return false">
        <textarea id="output-text" class="form-control" rows="20"></textarea>
      </form>
    </div>

</div>
  <br><br>
  <div class="row">
    <div class="col-lg-6">
      <form id="testing" style="" action="" method="" onsubmit="">
        <input id="topUrl" type="text" name="url" /> 
        <input id="cloudinary" style="display:none" name="file" type="file" class="cloudinary-fileupload" data-cloudinary-field="image_id" data-form-data=""></input>
        <div class="preview"></div>


          <!-- Placeholder that tells Preview where to put the selector-->
        <div class="selector-wrapper">
          <!-- <div class="selector-wrapper">
            <div class="selector">
                <div class="thumb">
                  <div class="controls" style="display: none;">
                    <a class="left" href="#">◀</a>
                    <a class="right" href="#">▶</a>
                    <a class="nothumb" href="#">✕</a>
                  </div>
                  <div class="items">
                    <ul class="images">
                      <li>
                        <img src="http://i2.wp.com/betterthansuccess.com/wp-content/uploads/2016/04/choose-the-business-that-right-for-you.jpg?fit=1000%2C563" data-url="http://i2.wp.com/betterthansuccess.com/wp-content/uploads/2016/04/choose-the-business-that-right-for-you.jpg?fit=1000%2C563">
                      </li>
                      <li>
                        <img src="http://i2.wp.com/betterthansuccess.com/wp-content/uploads/2016/04/choose-the-business-that-right-for-you.jpg?resize=696%2C392" data-url="http://i2.wp.com/betterthansuccess.com/wp-content/uploads/2016/04/choose-the-business-that-right-for-you.jpg?resize=696%2C392">
                      </li>
                      <li>
                        <img src="http://betterthansuccess.com/wp-content/uploads/2016/04/choose-the-business-that-right-for-you.jpg" data-url="http://betterthansuccess.com/wp-content/uploads/2016/04/choose-the-business-that-right-for-you.jpg">
                      </li>
                      <li>
                        <img src="http://betterthansuccess.com/wp-content/uploads/2016/03/LidyrAd.jpg" data-url="http://betterthansuccess.com/wp-content/uploads/2016/03/LidyrAd.jpg"></li><li><img src="http://i0.wp.com/betterthansuccess.com/wp-content/uploads/2016/06/BTS-Twitter-Banner.jpg?resize=218%2C150" data-url="http://i0.wp.com/betterthansuccess.com/wp-content/uploads/2016/06/BTS-Twitter-Banner.jpg?resize=218%2C150">
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="attributes">
                  <a class="title" href="#" contenteditable="true">Workbook: How to Choose the Right StartUp Business for You - Better Than Success</a>
                  <p>
                    <a class="description" href="#" contenteditable="true">So last week I wrote an article "3 Reasons Why Every New Entrepreneur Should Focus on Running ONLY One Business at a Time". We received a lot of feedback about that article.</a>
                  </p>
                  <span class="meta">
                    <img class="favicon" src="http://betterthansuccess.com/wp-content/uploads/2016/02/favicon.jpg">
                    <a class="provider" href="http://betterthansuccess.com">betterthansuccess.com</a>
                  </span>
                </div>
                <div class="action" style="display: none;">
                  <a href="#" class="close">✕</a>
                </div>
              </div>
            </div> -->
        </div> 
        <button id="preview1" class="btn btn-default">GO</button><br>
        <button id="upload" class="btn btn-default">UPLOAD</button>
      </form>
    </div>
  </div>

</body>



<script type="text/javascript">

 // img src



$(document).ready(function() {

$('#testing').submit(function(e) {
  $(this).addInputs($('#topUrl').data('preview'));
  return true;
})



// function render(data, options){
//   console.log(data);
//   console.log(options);
//   renderCallback(data, options);
// }

// function renderCallback(rcdata, rcoptions, callback) {
//      rcdata = rcdata || {},
//       rcoptions = rcoptions || {};

//   return callback(rcdata, rcoptions);
// }

// $('#testing').on('render', function(event, callback) {
//    $(renderCallback(undefined, undefined, callback() ))();

// })
// function publicId() {
//   var id = $('#url').val().replace(".",""). slice(7,-2)+"bp9";
//   console.log("id: "+ id);
//   return id;
// }
var uploadSuccess = 0;

function upload(file, callback) {
  $.cloudinary.config({ cloud_name: 'derfniizj', api_key: '876798113873355'});
  $.post('https://api.cloudinary.com/v1_1/derfniizj/image/upload', { 
    file: file,
    upload_preset: 'goa4ecqd',
    tags: ['social-enhance', 'PP']
  }, function() {
    // console.log(data);
  })
  .done(function(data) {
    // console.log(data);
    uploadSuccess ++;
    return callback(
      null, {
      id: data.public_id,
      version: data.version,
      format: data.format,
      url: data.url
    });
  })
  .fail(function(data) {
    return callback({
      error: data.responseText,
      errorStatus: data.statusText
      }, null
    );
    alert('upload failed!')
    console.log(data);
    console.log(data.responseText);
    console.log(data.statusText);
    console.log(data.readyState);
  });
};

$('#upload').click(function(e) {
  e.preventDefault;
  $('#topUrl').trigger('preview');
  var img = $('.selector-wrapper ul.images img')[0].src;
  if ( img ) { upload(img, function(image) { console.log(image) }) }
});



$('#topUrl').preview({
  key: '46c5dd3181b848ab9fdc5deb80f88dfb',
  // bind: false,
  error: function(obj){
    alert('The URL you entered was not processed.');
  },
  success: function(obj){
    pushImgUrls(obj, callback);
    console.log("success");
  }
  // render: render
});

// http://res.cloudinary.com/derfniizj/image/upload/v[verion]/[public_id].[format]

// $('.cloudinary-fileupload').unsigned_cloudinary_upload("goa4ecqd", { cloud_name: "derfniizj" }).bind('cloudinarydone', function(e, data) { 
//   $('.preview').html(
//     $.cloudinary.image(data.result.public_id, 
//       { format: data.result.format, version: data.result.version, 
//         crop: 'fill', width: 150, height: 100 })
//   );    
//   $('.image_public_id').val(data.result.public_id);    
//   return true;
// });
  

// $('#upload').click(function() {
//   $.post()
// })

var 
urlArrOut = new Array(),
doneUrlOut = new Array(),
urlArrIn = new Array(),
doneUrlIn = new Array(),
uploadArr = new Array(),
urlImages = new Array(),
imgCounter = ['[One] ','[Two] ','[Three] '],
textOut = "",
// inLen = 0,
outLen = 0, 
accessToken = 'def06aed7b93c3efe2dce5d57c9d3af833931770',
api = 'https://api-ssl.bitly.com/v3/shorten?access_token=' + accessToken + '&longUrl=',
expandApi = 'https://api-ssl.bitly.com/v3/expand?access_token=' + accessToken + '&shortUrl=',
regExUrl = new RegExp(/(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w\.-]*)*\/?/, 'gi'),

inLineText = "",
done = 0;

$('#input').submit(function(e, inLineText){
  e.preventDefault();
  inText = $('#input-text').val();
  inLineText = inText.replace(/\r?\n|\r/g, ' !###! ');
  console.log("in 173");
  UrlInToArray(inLineText);
})



// Grab all URLs from Input Text and put into Array urlArrIn
function UrlInToArray(inLineText) {
  var tempArr,
  done = inLineText.match(regExUrl).length;
  // urlArrIn ? urlArrIn.length = 0 : null;

  while ( (tempArr = regExUrl.exec(inLineText) ) !== null ) {
    urlArrIn.push(tempArr[0]);
    console.log(urlArrIn.length)
    console.log(done)
  }

  if ( urlArrIn.length === done ) { switchUpUrls(); }
} 

function switchUpUrls() {
  var arr4 = urlArrIn;

  for (let u in arr4) {
    $.getJSON(api + encodeURIComponent(arr4[u]), function(result) {
      if (result.status_code === 200) {
        urlArrOut.push(result.data.url);
      } else { 
        throw new Error(result.status_txt);
      }
      // if  ( urlArrOut.length === arr.length ) {
        // grabImagesFromUrls();
      // }
    }); 

    // setTimeout(function() {if (urlArrOut.indexOf(undefined) = -1) {
    //   console.log("GRAB FORMS"); grabImagesFromUrls(); }
    // }, 5000);
  }

  if ( urlArrOut.length === done ) { mapUrlOut(); }
}


  // var testArrOut9 = urlArrOut;
  // var setInt1 = window.setInterval(intCallback(testArrOut9), 2000);
  
  // function intCallback(testArrOut9) {
  //   if ( testArrOut9.indexOf(undefined) < 0 ) {
  //     clearInterval(setInt1);
      
  //     console.log("0"+testArrOut9);
  //   } else { console.log(testArrOut9); }
  // }
  // } 

  function mapUrlOut(callback) {
    urlArrOut.map(function(url) {
      setUrlData(url, triggerDone);
    })
    callback(grabImagesFromUrls);
  }

   function pushImgUrls(obj, callback) {
    urlImages.push(obj.url);
    var triggerDone = callback();
  }

  function setUrlData(url, callback) {
    document.getElementById('topUrl').value = url;
    $('#topUrl').trigger('preview');
    callback(triggerDone);
  }


  //      // $('#topUrl').data('preview')
  //      // console.log("doneImgMappingOUt@")

  // function mapCallback(url, i, arr, callback) {
  //   getTriggerDone()
   

  // }    

 



      // var setInt2 = window.setInterval(intCallback2(urlArrOut), 1000);
      // var counter2 = 0;
      // console.log("outside counter " + counter2); 

      // function intCallback2() { 
      //   if ( typeof $('.selector-wrapper ul.images img')[counter2] !== 'undefined' ) {
      //     urlImages = urlArrOut.map(function fourten(url, counter2) {
      //       console.log("in counter2 =" + counter2);
      //       return $('.selector-wrapper ul.images img')[i].src;
      //       counter2 ++;
      //       if (counter2 === urlArrOut.length -1 ) { clearInterval(setInt2); console.log("dleftcounter2"); }
      //     })
      //   } else { return counter2 = 0; console.log("zero 0 counter") }
      // }
  
  
  

    

    uploadWaiter.call();

    console.log("OUT OF URL IMAGES");

   // while (previewSuccess.length < urlImages.length) { setTimeout(function() {return previewSuccess.length;}, 1000); }
    // console.log("OUT OF SUCCESS WHILE");
   function uploadWaiter() { console.log("INSIDE UPLOAD WAITER");
     if(typeof urlImages != "undefined" && urlImages != null && urlImages.length > 0 &&  urlImages.length === urlArrOut.length){
      uploadTime();
    } else { setTimeout(function() { uploadWaiter(); }, 3000); }

      function uploadTime() {
        //   emArr = Array.from($('.selector-wrapper ul.images img')).slice(0,3),
        //   imgArr = emArr.map(function(val, i, arr) { return arr[i].src });
        var urlImgTmp = urlImages;
        uploadArr = urlImgTmp.map(function(val, i) {
          upload(val, function(err, result) {
            if (err) { return err; }
            if (result) { return result.url; }
          });
        });
      
      textWaiter();
      // while (uploadSuccess.length < uploadArr.length) { setTimeout(function() {return uploadSuccess.length;}, 1000); }
      // console.log("INSIDE UPLOAD SUCCESS");
      function textWaiter() { console.log("TEXT WAITER");
        if(typeof uploadArr != "undefined" && uploadArr != null && uploadArr.length > 0 &&  uploadArr.length === urlImages.length){
          sendText(); 
        } else { setTimeout(function() { textWaiter(); }, 3000); }

          function sendText() { console.log("SENDING TEXT");
                  var 
                    i = 0,        
                    outLineText = new Array();
                    outLineText.push(inLineText);

          while ( (tempArr2 = regExUrl.exec(inLineText) ) !== null ) {
            var 
              oldy = tempArr2[0],
              newy = urlArrOut[i],
              imgy = uploadArr[i];

            if (typeof newy === 'string') {
              outLineText[i+1] = outLineText[i].replace(oldy, newy);
              outLineText[i+1] += '\nImages: ' + imgy.map(function(val, i) {
                return '['+imgCounter[i]+']('+val+')';
              })
              console.log(oldy, newy);
              i ++;
            }
        }

          if ( i === done ) {
            var outText = outLineText[done].replace(/\s!###!\s/g, '\n');
            $('#output-text').val(outText);
          }
        } 
      }
    }
  } 
 


  function urlCheck() {
    var arrIn2 = doneUrlIn; 
    var arrOut2 = doneUrlOut;

      for (let url of arrIn2) {
        for (let lru of arrOut2) {
          inWindow = window.open(url);
          outWindow = window.open(lru);
        }
        (inWindow.window.location === outWindow.document.domain) ? console.log("OK URL " + lru) : alert("BAD URL " + lru);
      }
  }

    $('#checkUrls').click(function(e) {
      e.preventDefault; 
      urlCheck(doneUrlIn, doneUrlOut);
    })

  

  function logging(data) {
    console.log(data);
  }

   function returnIt(data) {
    return data;
  }

  


  $('form#output').submit(function(e){
      e.preventDefault();
  })



  function resetPage() {
    location.reload(true);
  }


  $('#copyReset').click( function(e) {
    e.preventDefault;

     var inp = $('#input-text');

    // select text
    inp.select();

    try {
      // copy text
      document.execCommand('copy');
      setTimeout(resetPage(), 200);
    }
    catch (err) {
      alert('please press Ctrl/Cmd+C to copy');
    }
  })

});



</script>


</html>